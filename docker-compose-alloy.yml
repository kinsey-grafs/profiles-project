# Local dev stack using Grafana Alloy (recommended for production-like setup)
# Alloy replaces the OpenTelemetry Collector - it's Grafana's recommended collector.
#
# Run: docker compose -f docker-compose-alloy.yml up -d
# With apps: docker compose -f docker-compose-alloy.yml --profile full up -d

services:
  api-gateway:
    build:
      context: .
      dockerfile: services/api-gateway/Dockerfile
    ports:
      - "3000:3000"
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://alloy:4318
      - PYROSCOPE_URL=http://pyroscope:4040
      - OTEL_SERVICE_NAME=api-gateway
      - BACKEND_URL=http://backend:3001
    depends_on:
      - alloy
      - pyroscope
      - backend
    profiles:
      - full

  backend:
    build:
      context: .
      dockerfile: services/backend/Dockerfile
    ports:
      - "3001:3001"
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://alloy:4318
      - PYROSCOPE_URL=http://pyroscope:4040
      - OTEL_SERVICE_NAME=backend
    depends_on:
      - alloy
      - pyroscope
    profiles:
      - full

  load-generator:
    image: node:20-alpine
    working_dir: /app
    volumes:
      - .:/app
    command: ["node", "scripts/load-generator.js", "--url=http://api-gateway:3000", "--interval=300"]
    depends_on:
      - api-gateway
    profiles:
      - full

  alloy:
    image: grafana/alloy:latest
    ports:
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
    volumes:
      - ./alloy/config.local.alloy:/etc/alloy/config.alloy
    command: ["run", "/etc/alloy/config.alloy", "--server.http.listen-addr=0.0.0.0:12345"]
    depends_on:
      - loki

  tempo:
    image: grafana/tempo:latest
    ports:
      - "3200:3200"
      - "4317:4317"
      - "4318:4318"
    volumes:
      - ./tempo-config.yaml:/etc/tempo.yaml
    command: ["-config.file=/etc/tempo.yaml"]

  pyroscope:
    image: grafana/pyroscope:latest
    ports:
      - "4040:4040"
    command: ["server"]

  loki:
    image: grafana/loki:latest
    ports:
      - "3100:3100"
    volumes:
      - ./loki-config.yaml:/etc/loki/config.yaml
    command: ["-config.file=/etc/loki/config.yaml"]

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3030:3000"
    depends_on:
      - loki
    environment:
      - GF_FEATURE_TOGGLES_ENABLE=flameGraph traceqlSearch traceToProfiles
      - GF_INSTALL_PLUGINS=grafana-pyroscope-datasource
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_AUTH_DISABLE_LOGIN_FORM=true
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning
    depends_on:
      - tempo
      - pyroscope
