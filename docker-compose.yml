# Local dev stack: OpenTelemetry Collector, Tempo, Pyroscope, Grafana
# Run: docker compose up -d
# With apps: docker compose --profile full up -d (includes Node services + load generator)

services:
  api-gateway:
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health',r=>process.exit(r.statusCode===200?0:1))"]
      interval: 5s
      timeout: 3s
      retries: 3
    build:
      context: .
      dockerfile: services/api-gateway/Dockerfile
    ports:
      - "3000:3000"
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://opentelemetry-collector:4318
      - PYROSCOPE_URL=http://pyroscope:4040
      - OTEL_SERVICE_NAME=api-gateway
      - BACKEND_URL=http://backend:3001
    depends_on:
      - opentelemetry-collector
      - pyroscope
      - backend
    profiles:
      - full

  backend:
    build:
      context: .
      dockerfile: services/backend/Dockerfile
    ports:
      - "3001:3001"
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://opentelemetry-collector:4318
      - PYROSCOPE_URL=http://pyroscope:4040
      - OTEL_SERVICE_NAME=backend
    depends_on:
      - opentelemetry-collector
      - pyroscope
    profiles:
      - full

  load-generator:
    image: node:20-alpine
    working_dir: /app
    volumes:
      - .:/app
    command: ["node", "scripts/load-generator.js", "--url=http://api-gateway:3000", "--interval=300"]
    depends_on:
      - api-gateway
    profiles:
      - full

  opentelemetry-collector:
    image: otel/opentelemetry-collector-contrib:latest
    ports:
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
    volumes:
      - ./otel-config.yaml:/etc/otel-collector-config.yaml
    command: ["--config=/etc/otel-collector-config.yaml"]
    depends_on:
      - loki

  tempo:
    image: grafana/tempo:latest
    ports:
      - "3200:3200"
      - "4317:4317"
      - "4318:4318"
    volumes:
      - ./tempo-config.yaml:/etc/tempo.yaml
    command: ["-config.file=/etc/tempo.yaml"]

  pyroscope:
    image: grafana/pyroscope:latest
    ports:
      - "4040:4040"
    command: ["server"]

  loki:
    image: grafana/loki:latest
    ports:
      - "3100:3100"
    volumes:
      - ./loki-config.yaml:/etc/loki/config.yaml
    command: ["-config.file=/etc/loki/config.yaml"]

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3030:3000"
    depends_on:
      - loki
    environment:
      - GF_FEATURE_TOGGLES_ENABLE=flameGraph traceqlSearch traceToProfiles
      - GF_INSTALL_PLUGINS=grafana-pyroscope-datasource
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_AUTH_DISABLE_LOGIN_FORM=true
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/var/lib/grafana/dashboards
    depends_on:
      - tempo
      - pyroscope
      - loki
